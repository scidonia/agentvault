digraph TitleCardQueryAgent {
    // Graph attributes
    rankdir=TB;
    bgcolor="white";
    fontname="Arial";
    fontsize=14;
    labelloc="t";
    label="Title Card Query Agent - LangGraph Workflow";
    
    // Node styling
    node [
        shape=box,
        style="rounded,filled",
        fontname="Arial",
        fontsize=12,
        margin=0.3
    ];
    
    // Edge styling
    edge [
        fontname="Arial",
        fontsize=10,
        color="#666666"
    ];
    
    // Input/Output nodes
    start [
        label="üîç User Question\n(Input)",
        fillcolor="#E3F2FD",
        color="#1976D2",
        fontcolor="#1976D2"
    ];
    
    end [
        label="ü§ñ Final Answer\n+ Citations\n(Output)",
        fillcolor="#E8F5E8",
        color="#388E3C",
        fontcolor="#388E3C"
    ];
    
    // Processing nodes
    search_titles [
        label="üîç Search Title Cards\n\n‚Ä¢ Generate question embedding\n‚Ä¢ Vector search in LanceDB\n‚Ä¢ Find top 50 similar documents\n‚Ä¢ Calculate similarity threshold",
        fillcolor="#FFF3E0",
        color="#F57C00",
        fontcolor="#E65100"
    ];
    
    gather_phrases [
        label="üìö Gather Phrases\n\n‚Ä¢ Load phrasal data from parquet\n‚Ä¢ Filter phrases for relevant docs\n‚Ä¢ Organize by document\n‚Ä¢ Select top excerpts per doc",
        fillcolor="#F3E5F5",
        color="#7B1FA2",
        fontcolor="#4A148C"
    ];
    
    generate_answer [
        label="ü§ñ Generate Answer\n\n‚Ä¢ Create structured citations\n‚Ä¢ Combine summaries + excerpts\n‚Ä¢ Generate comprehensive answer\n‚Ä¢ Include citation references",
        fillcolor="#E0F2F1",
        color="#00796B",
        fontcolor="#004D40"
    ];
    
    // Data stores (external dependencies)
    subgraph cluster_data {
        label="Data Sources";
        style="dashed";
        color="#BDBDBD";
        fontcolor="#757575";
        
        lancedb [
            label="üóÑÔ∏è LanceDB\n(Vector Store)",
            shape=cylinder,
            fillcolor="#FFEBEE",
            color="#C62828",
            fontcolor="#B71C1C"
        ];
        
        phrases_db [
            label="üìÑ Phrases Parquet\n(Text Excerpts)",
            shape=cylinder,
            fillcolor="#FFEBEE",
            color="#C62828",
            fontcolor="#B71C1C"
        ];
        
        openai [
            label="üß† OpenAI API\n(Embeddings + Chat)",
            shape=ellipse,
            fillcolor="#FFF8E1",
            color="#FF8F00",
            fontcolor="#E65100"
        ];
    }
    
    // State flow
    start -> search_titles [label="user_question"];
    search_titles -> gather_phrases [label="search_results\nsearch_threshold"];
    gather_phrases -> generate_answer [label="relevant_phrases"];
    generate_answer -> end [label="final_answer\ncitations"];
    
    // Data dependencies
    search_titles -> lancedb [style=dashed, label="vector search", color="#C62828"];
    search_titles -> openai [style=dashed, label="embedding", color="#FF8F00"];
    gather_phrases -> phrases_db [style=dashed, label="load phrases", color="#C62828"];
    generate_answer -> openai [style=dashed, label="chat completion", color="#FF8F00"];
    
    // State information box
    subgraph cluster_state {
        label="Query State (TypedDict)";
        style="dotted";
        color="#9E9E9E";
        fontcolor="#616161";
        
        state_info [
            label="üìã State Variables:\n\n‚Ä¢ user_question: str\n‚Ä¢ search_results: List[Dict]\n‚Ä¢ relevant_phrases: List[Dict]\n‚Ä¢ citations: List[Dict]\n‚Ä¢ final_answer: str\n‚Ä¢ search_threshold: float\n‚Ä¢ error: Optional[str]",
            shape=note,
            fillcolor="#FAFAFA",
            color="#9E9E9E",
            fontcolor="#424242"
        ];
    }
    
    // Processing details
    subgraph cluster_details {
        label="Key Processing Details";
        style="dotted";
        color="#607D8B";
        fontcolor="#455A64";
        
        details [
            label="‚öôÔ∏è Configuration:\n\n‚Ä¢ Top-K: 50 documents\n‚Ä¢ Embedding Model: OpenAI\n‚Ä¢ Vector DB: LanceDB\n‚Ä¢ Max phrases per doc: 20\n‚Ä¢ Answer generation: GPT-4\n‚Ä¢ Temperature: 0.3",
            shape=note,
            fillcolor="#ECEFF1",
            color="#607D8B",
            fontcolor="#37474F"
        ];
    }
}
